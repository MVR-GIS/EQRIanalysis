
```{r}
library(here)
library(readr)
library(dplyr)
```

```{r}
# Get latest .csv 
latest_export <- here("UR_QRI_RESPONSE_EDA_20260122.csv")

# Ensure file present
if (!file.exists(latest_export)) {
    stop("CSV file not found: ", latest_export)
}
```

```{r get-static-data}
# Get static export
message("Reading raw CSV data...")
tryCatch({
    responses_raw <- read_csv(latest_export)
}, error = function(e) {
    stop("Failed to load data: ", e$message)
})

# Get column spec
column_types <- spec(responses_raw)

message("Adjusting column spec...")
# Adjust column types
column_types$cols$PROJECT_ID <- col_integer()
column_types$cols$SUBPROJECT_ID  <- col_integer()
column_types$cols$RESPONSE_UID  <- col_integer()
column_types$cols$QUESTIONNAIREEVENT_ID  <- col_integer()
column_types$cols$QUESTION_NUMBER  <- col_integer()
column_types$cols$MILESTONE_ID  <- col_integer()
column_types$cols$PROGRAMTYPE_ID  <- col_integer()

responses_clean <- readr::read_csv(
    latest_export,
    col_types = column_types)
```

```{r data-prep}
responses <- responses_clean %>%
    mutate(
        PROGRAMTYPE_NAME = case_when(
            PROGRAMTYPE_ID == 1 ~ "Military",
            PROGRAMTYPE_ID == 2 ~ "Civil Works"
        )
    ) %>%
    relocate(PROGRAMTYPE_NAME, .after = PROGRAMTYPE_ID)
```

```{r save-data}
response_rds_file_path <- here("responses.rds")

tryCatch({
    saveRDS(responses, response_rds_file_path)
}, error = function(e) {
    stop("Failed to save data: ", e$message)
})

if (!file.exists(response_rds_file_path)) {
    stop("response.rds file not found: ", response_rds_file_path)
}
```
